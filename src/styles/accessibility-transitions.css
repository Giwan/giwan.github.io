/**
 * Enhanced Accessibility Support for View Transitions
 * 
 * Provides comprehensive reduced motion support, focus management,
 * and accessibility-first transition behaviors.
 */

@layer components {
  /* Enhanced Reduced Motion Support */
  
  /* System preference detection */
  @media (prefers-reduced-motion: reduce) {
    :root {
      --transition-duration-fast: 0ms !important;
      --transition-duration-normal: 0ms !important;
      --transition-duration-slow: 0ms !important;
    }
    
    /* Disable all view transitions */
    ::view-transition-old(root),
    ::view-transition-new(root),
    ::view-transition-old(main-content),
    ::view-transition-new(main-content),
    ::view-transition-old(header),
    ::view-transition-new(header),
    ::view-transition-old(footer),
    ::view-transition-new(footer),
    ::view-transition-old(navigation),
    ::view-transition-new(navigation) {
      animation: none !important;
    }
    
    /* Disable transform animations */
    * {
      transform: none !important;
      animation: none !important;
      transition: none !important;
    }
    
    /* Allow only essential opacity changes for focus indicators */
    :focus,
    :focus-visible,
    :hover {
      transition: opacity 0ms ease !important;
    }
  }

  /* Manual reduced motion override */
  [data-reduced-motion="true"] {
    --transition-duration-fast: 0ms !important;
    --transition-duration-normal: 0ms !important;
    --transition-duration-slow: 0ms !important;
  }

  [data-reduced-motion="true"] ::view-transition-old(root),
  [data-reduced-motion="true"] ::view-transition-new(root),
  [data-reduced-motion="true"] ::view-transition-old(main-content),
  [data-reduced-motion="true"] ::view-transition-new(main-content),
  [data-reduced-motion="true"] ::view-transition-old(header),
  [data-reduced-motion="true"] ::view-transition-new(header),
  [data-reduced-motion="true"] ::view-transition-old(footer),
  [data-reduced-motion="true"] ::view-transition-new(footer),
  [data-reduced-motion="true"] ::view-transition-old(navigation),
  [data-reduced-motion="true"] ::view-transition-new(navigation) {
    animation: none !important;
  }

  [data-reduced-motion="true"] * {
    transform: none !important;
    animation: none !important;
    transition: none !important;
  }

  /* Preserve essential focus indicators even with reduced motion */
  [data-reduced-motion="true"] :focus,
  [data-reduced-motion="true"] :focus-visible {
    transition: opacity 0ms ease !important;
  }

  /* Enhanced Focus Management */
  
  /* Focus indicators for transition elements */
  ::view-transition-old(main-content):focus,
  ::view-transition-new(main-content):focus {
    outline: 2px solid hsl(var(--ring));
    outline-offset: 2px;
  }

  /* Skip link enhancements */
  .skip-link {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    z-index: 9999 !important;
    padding: 0.5rem 1rem !important;
    background: hsl(var(--primary)) !important;
    color: hsl(var(--primary-foreground)) !important;
    font-weight: 600 !important;
    text-decoration: none !important;
    border-radius: 0 0 0.375rem 0 !important;
    transform: translateY(-100%) !important;
    transition: transform 0.2s ease !important;
    view-transition-name: skip-link;
  }

  .skip-link:focus {
    transform: translateY(0) !important;
    outline: 2px solid hsl(var(--ring)) !important;
    outline-offset: 2px !important;
  }

  /* Reduced motion skip link behavior */
  @media (prefers-reduced-motion: reduce) {
    .skip-link {
      transition: none !important;
    }
    
    .skip-link:focus {
      transform: translateY(0) !important;
    }
  }

  [data-reduced-motion="true"] .skip-link {
    transition: none !important;
  }

  [data-reduced-motion="true"] .skip-link:focus {
    transform: translateY(0) !important;
  }

  /* Accessibility landmark transitions */
  
  /* Main content landmark */
  main[role="main"] {
    view-transition-name: main-content;
  }

  /* Navigation landmark */
  nav[aria-label="Main navigation"] {
    view-transition-name: navigation;
  }

  /* Header landmark */
  header[role="banner"] {
    view-transition-name: header;
  }

  /* Footer landmark */
  footer[role="contentinfo"] {
    view-transition-name: footer;
  }

  /* Search landmark */
  [role="search"] {
    view-transition-name: search;
  }

  /* Complementary content */
  aside[role="complementary"] {
    view-transition-name: sidebar;
  }

  /* Focus management during transitions */
  
  /* Ensure main content can receive focus */
  main[role="main"] {
    outline: none;
  }

  main[role="main"]:focus {
    outline: 2px solid hsl(var(--ring));
    outline-offset: 2px;
  }

  /* Focus ring for transitioning elements */
  [data-transitioning="true"] :focus {
    outline: 2px solid hsl(var(--ring)) !important;
    outline-offset: 2px !important;
    z-index: 1000 !important;
  }

  /* Screen reader only content */
  .sr-only {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }

  /* Screen reader announcer */
  #accessibility-announcer {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    ::view-transition-old(main-content),
    ::view-transition-new(main-content) {
      /* Simplify animations for high contrast */
      animation-duration: var(--transition-duration-fast) !important;
    }
    
    /* Enhanced focus indicators */
    :focus,
    :focus-visible {
      outline: 3px solid !important;
      outline-offset: 3px !important;
    }
    
    .skip-link:focus {
      outline: 3px solid hsl(var(--background)) !important;
      outline-offset: 2px !important;
    }
  }

  /* Keyboard navigation enhancements */
  
  /* Visible focus indicators for keyboard users */
  :focus-visible {
    outline: 2px solid hsl(var(--ring)) !important;
    outline-offset: 2px !important;
  }

  /* Enhanced focus for interactive elements during transitions */
  [data-transitioning="true"] a:focus,
  [data-transitioning="true"] button:focus,
  [data-transitioning="true"] input:focus,
  [data-transitioning="true"] select:focus,
  [data-transitioning="true"] textarea:focus {
    outline: 2px solid hsl(var(--ring)) !important;
    outline-offset: 2px !important;
    z-index: 1001 !important;
  }

  /* Transition-aware focus styles */
  ::view-transition-old(*):focus,
  ::view-transition-new(*):focus {
    outline: 2px solid hsl(var(--ring)) !important;
    outline-offset: 2px !important;
  }

  /* Loading state accessibility */
  
  /* Loading indicators */
  [aria-live="polite"],
  [aria-live="assertive"] {
    view-transition-name: none; /* Don't transition live regions */
  }

  /* Loading spinner accessibility */
  .loading-spinner {
    view-transition-name: loading-indicator;
  }

  /* Ensure loading states are announced */
  [data-loading="true"] {
    position: relative;
  }

  [data-loading="true"]::after {
    content: "Loading...";
    position: absolute;
    left: -10000px;
    width: 1px;
    height: 1px;
    overflow: hidden;
  }

  /* Error state accessibility */
  
  /* Error messages */
  [role="alert"] {
    view-transition-name: none; /* Don't transition alerts */
  }

  /* Error focus management */
  .error-focus {
    outline: 2px solid hsl(var(--destructive)) !important;
    outline-offset: 2px !important;
  }

  /* Transition state indicators for assistive technology */
  
  /* Indicate when transitions are active */
  [data-transitioning="true"] {
    /* This will be announced by screen readers */
  }

  [data-transitioning="true"]::before {
    content: "Page transitioning";
    position: absolute;
    left: -10000px;
    width: 1px;
    height: 1px;
    overflow: hidden;
  }

  /* Mobile accessibility enhancements */
  
  @media (max-width: 768px) {
    /* Larger touch targets */
    .skip-link {
      padding: 0.75rem 1.25rem !important;
      font-size: 1rem !important;
    }
    
    /* Enhanced focus indicators for touch */
    :focus,
    :focus-visible {
      outline-width: 3px !important;
      outline-offset: 3px !important;
    }
  }

  /* Print accessibility */
  
  @media print {
    /* Disable all transitions for print */
    ::view-transition-old(*),
    ::view-transition-new(*) {
      animation: none !important;
    }
    
    /* Hide skip links in print */
    .skip-link {
      display: none !important;
    }
    
    /* Show all content in print */
    .sr-only {
      position: static !important;
      width: auto !important;
      height: auto !important;
      padding: 0 !important;
      margin: 0 !important;
      overflow: visible !important;
      clip: auto !important;
      white-space: normal !important;
    }
  }

  /* Enhanced keyboard navigation indicators */
  
  /* Focus ring for keyboard users during transitions */
  [data-transitioning="true"] *:focus-visible {
    outline: 3px solid hsl(var(--ring)) !important;
    outline-offset: 3px !important;
    z-index: 1002 !important;
    position: relative !important;
  }

  /* Enhanced focus for interactive elements */
  [data-transitioning="true"] a:focus-visible,
  [data-transitioning="true"] button:focus-visible {
    outline: 3px solid hsl(var(--primary)) !important;
    outline-offset: 2px !important;
    background-color: hsl(var(--accent)) !important;
  }

  /* Focus trap during transitions */
  [data-focus-trapped="true"] {
    position: relative;
  }

  [data-focus-trapped="true"]::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.1);
    z-index: 999;
    pointer-events: none;
  }

  /* Announcement region styling */
  #accessibility-announcer {
    /* Ensure it's completely hidden but accessible */
    position: absolute !important;
    left: -10000px !important;
    top: auto !important;
    width: 1px !important;
    height: 1px !important;
    overflow: hidden !important;
  }

  /* Enhanced skip link animations */
  .skip-link {
    transform: translateY(-100%) !important;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
  }

  .skip-link:focus {
    transform: translateY(0) !important;
    animation: skip-link-appear 0.3s ease-out !important;
  }

  @keyframes skip-link-appear {
    0% {
      transform: translateY(-100%) scale(0.9);
      opacity: 0;
    }
    50% {
      transform: translateY(-10px) scale(1.05);
      opacity: 0.8;
    }
    100% {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
  }

  /* Respect reduced motion for skip links */
  @media (prefers-reduced-motion: reduce) {
    .skip-link {
      transition: none !important;
      animation: none !important;
    }
    
    .skip-link:focus {
      transform: translateY(0) !important;
    }
  }

  [data-reduced-motion="true"] .skip-link {
    transition: none !important;
    animation: none !important;
  }

  [data-reduced-motion="true"] .skip-link:focus {
    transform: translateY(0) !important;
  }

  /* Preference-based customizations */
  
  /* Respect color scheme preferences */
  @media (prefers-color-scheme: dark) {
    .skip-link {
      background: hsl(var(--primary)) !important;
      color: hsl(var(--primary-foreground)) !important;
    }
  }

  /* Respect transparency preferences */
  @media (prefers-reduced-transparency: reduce) {
    ::view-transition-old(*),
    ::view-transition-new(*) {
      opacity: 1 !important;
    }
  }

  /* Enhanced contrast mode support */
  @media (prefers-contrast: high) {
    /* Stronger focus indicators */
    :focus-visible {
      outline: 4px solid !important;
      outline-offset: 4px !important;
    }
    
    /* Enhanced skip link visibility */
    .skip-link:focus {
      outline: 4px solid hsl(var(--background)) !important;
      outline-offset: 2px !important;
      box-shadow: 0 0 0 8px hsl(var(--primary)) !important;
    }
    
    /* Stronger transition indicators */
    [data-transitioning="true"]::before {
      background: rgba(0, 0, 0, 0.3) !important;
    }
  }

  /* Force colors mode support */
  @media (forced-colors: active) {
    .skip-link {
      background: ButtonFace !important;
      color: ButtonText !important;
      border: 2px solid ButtonText !important;
    }
    
    .skip-link:focus {
      background: Highlight !important;
      color: HighlightText !important;
      outline: 2px solid HighlightText !important;
    }
    
    /* Ensure focus indicators are visible */
    :focus-visible {
      outline: 2px solid HighlightText !important;
      outline-offset: 2px !important;
    }
  }
}